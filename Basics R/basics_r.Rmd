```{r}
library(stringr)
```


# Module 2: advanced structures

## 2.1 Matrix and lists

## 2.2 Dataframes

Дата фрейм `attitude` -- встроенный массив данных, содержащий рейтинг департаментов одной финансовой компании, составленный сотрудниками. Представьте, что вы хотите устраиваться как раз в эту компанию, и дата фрейм (совершенно случайно!) оказался в вашем распоряжении.

Вы решили, что самое главное для вас -- это возможность учиться новому (`learning`). Возьмите 5 топовых департаментов по этому показателю. Из этого набора вам более всего подойдёт тот департамент, который имеет наибольшую сумму баллов по трём показателям: реакция на жалобы работников (`complaints`), надбавки в зависимости от результатов работы (`raises`) и возможность продвижения (`advance`).

Какой же департамент вам выбрать? Напишите его номер XX (номер строки в дата фрейме).

```{r}
temp <- attitude[order(-attitude$learning)[1:5],c("complaints","raises","advance")]
which.max(rowSums(temp))
```

Вопросы:

> Количество станций, зарегистрировавших землетрясение, записанное третьим\
> Количество станций, зарегистрировавших землетрясение, записанное предпоследним\
> Медианная глубина землетрясений (км)\
> Минимальная сила землетрясений по шкале Рихтера\
> Максимальная сила землетрясений по шкале Рихтера\
> Средняя глубина землетрясений (км)

```{r}
summary(quakes)
```

```{r}
head(quakes)
tail(quakes)
```

Доцент кафедры прикладного анализа данных Арчибальд Нелёгких проделал ту же работу над массивом `avianHabitat`, что и мы, и отправил результаты учёным из Аляски. Сегодня утром он обнаружил в почтовом ящике письмо следующего содержания.

> Дорогой Арчи!\
> Получил твои расчёты. Твой вопрос относительно покрытия растительностью действительно обоснован: общее покрытие в самом деле достаточно низкое. Ты ведь не забыл, что мы работаем в Аляске? Смотри сам (фото справа):

[<http://minerals.usgs.gov/alaska/economic/sewpen.html>]

> Ладно, слушай, у меня к тебе ещё одна просьба. У нас тут стажёр из аспирантуры работает, зовут его Карлош Линнейес или как-то так. В общем, он забыл прикрепить свои измерения к общему файлу. Ты не мог бы принять его кусок данных, прикрепить его к общему массиву и пересчитать показатели?\
> Только имей в виду: этот аспирант рассеянный тип, наверняка он что-нибудь напортачил. Впрочем, для тебя это наверняка пустяки! Файл avianHabitat2.csv прикрепляю.\
> Заранее спасибо!\
> Дж.

<https://raw.githubusercontent.com/tonytonov/Rcourse/master/R%20programming/avianHabitat.csv>

<https://raw.githubusercontent.com/tonytonov/Rcourse/master/R%20programming/avianHabitat2.csv>

Помогите Арчибальду! Cкачайте файл по ссылке, добавьте новые данные в общий дата фрейм и повторите подсчёт общего покрытия, добавив переменную total_coverage. В качестве ответа пришлите величину среднего покрытия с точностью до второго знака: X.XX

Подсказки:

-   общий массив будет содержать 1088 наблюдений;\
-   добавление данных Карлоша увеличит среднее по переменной общего покрытия, но незначительно.

```{r}
habitat <- read.csv('https://raw.githubusercontent.com/tonytonov/Rcourse/master/R%20programming/avianHabitat.csv')

habitat2 <- read.csv('https://raw.githubusercontent.com/tonytonov/Rcourse/master/R%20programming/avianHabitat2.csv', skip = 5, sep = ';', header = T, comment.char = "%", na.strings = "Don't remember")

habitat2$Observer <- 'KL'

both_df <- rbind(habitat,habitat2)
```

```{r}
str(both_df)

summary(both_df)

# any(!complete.cases(both_df))
# 
# sum(!complete.cases(both_df))

# subset(both_df, any(!complete.cases(both_df)))

# both_df[!complete.cases(both_df),]

# p_names <- names(both_df)[-(1:4)][c(T, F)]

p_names <- names(both_df[grepl('P', names(both_df))])
both_df$total_coverage <- rowSums(both_df[,p_names])

summary(both_df$total_coverage)

# coverage_variables <- function(x)
```
Растительность Аляски, как мы уже знаем, достаточно скудна. Исследователям интересно, какие выдающиеся экземпляры растений удалось обнаружить? На массиве `avianHabitat` найдите максимальные высоты по каждому виду растений и отсортируйте эти виды по убыванию, от самого высокого к самому низкому.

Подсказки:

1. вас будут интересовать только данные переменных, отвечающих за высоты растений. Такие переменные заканчиваются на `Ht`;  
2. индексация с двойными скобками похожа на индексацию по значку доллара `$`, но есть одна тонкость: сравните результат  

> my_var <- "Site"; avian$my_var  
> my_var <- "Site"; avian[[my_var]]  

данные Карлоша можно не учитывать: он вылетел из аспирантуры.

```{r}
ht_names <- names(both_df[grepl('Ht', names(both_df))])
new_df <- both_df[c(ht_names)]
ans <- apply(new_df, 2, FUN = max)
sort(ans, decreasing = T)
```

## 2.3 Factors and strings

Чему равен результат вызова

`length("Аэрофотосъёмка ландшафта уже выявила земли богачей и процветающих крестьян.")`
А почему? А что мог бы ожидать человек, мало знакомый с векторами в R?
Найдите функцию базового R, которая возвращает длину (количество символов) строки. В ответе укажите название этой функции.

```{r}
nchar("Аэрофотосъёмка ландшафта уже выявила земли богачей и процветающих крестьян.")
```

```{r}
cats_print <- function(x){
  x <- as.numeric(x)
  if (x==1){
    return (print('One alone cat'))
  }
  else{
    return(sprintf('%s cats', x))
  }
}

cats_print(5)
```

В память о бедном Йорике я подготовил небольшую тираду и обработал её средствами `stringr`. Вы не могли бы дать мне небольшой лингвистический обзор этого предложения? Выполните следующий код, чтобы начать работу с фразой в удобной форме:

```{r}
hamlet <- "To be, or not to be: that is the question:
Whether 'tis nobler in the mind to suffer
The slings and arrows of outrageous fortune,
Or to take arms against a sea of troubles,
And by opposing end them?"

hamlet <- str_replace_all(hamlet, "[:punct:]", "")
hamlet <- tolower(unlist(str_split(hamlet, "[:space:]")))
```

1. Количество слов "to"  
2. Количество слов, содержащих любую букву из "f", "q" и "w"  
3. Количество слов, содержащих букву "b", после которой -- любой другой символ  
4. Количество слов ровно из семи букв  

```{r}
sum(str_count(hamlet, '\\b[tT]o\\b'))
sum(str_count(hamlet, '\\b\\w*[fqwW]\\w*\\b'))
sum(str_count(hamlet, '\\b\\w*b\\w+\\b'))
sum(str_count(hamlet, '\\b[\\w]{7}\\b'))
```

Используйте показанную мной связку из двух функций, чтобы превратить количественную переменную `mag` (сила землетрясения в баллах по шкале Рихтера) дата фрейма `quakes` в качественную. Интервалы должны быть длиной в полбалла, начиная с минимального, при этом левый конец интервала включается. Теперь отсортируйте общее количество случаев, попавших в каждую категорию, в порядке убывания.

> Подсказки:  

> 1. придётся чуть-чуть повозиться с аргументами;   
> 2. интервалы должны быть в точности такими, как указаны в ответах.  

```{r}

a <- seq(min(quakes$mag), ceiling(max(quakes$mag)), by = 0.5)
sort(table(cut(quakes$mag, br = a, right = FALSE, include.lowest=T)), decreasing = T)
```




